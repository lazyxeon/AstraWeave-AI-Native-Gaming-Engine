name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      # ---- OS prerequisites (Linux/macOS) ----
      - name: Install native deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          # Core dev tools
          sudo apt-get install -y build-essential pkg-config cmake ninja-build
          # X11 + GL/EGL for winit/glutin/egui (wgpu paths)
          sudo apt-get install -y \
            libx11-dev libxi-dev libxcursor-dev libxrandr-dev libxinerama-dev \
            libxkbcommon-dev libxkbcommon-x11-dev libx11-xcb-dev \
            libxcb1-dev libxcb-randr0-dev libxcb-xfixes0-dev libxcb-shape0-dev libxcb-xkb-dev \
            libgl1-mesa-dev libegl1-mesa-dev
          # Wayland headers (winit can target both X11 and Wayland)
          sudo apt-get install -y wayland-protocols libwayland-dev
          # Audio for cpal/rodio
          sudo apt-get install -y libasound2-dev libpulse-dev libudev-dev
          # Vulkan runtime (not strictly needed to compile, helpful for runtime CI/tools)
          sudo apt-get install -y mesa-vulkan-drivers vulkan-tools
          # Zip/other misc used by builds
          sudo apt-get install -y unzip zip

      - name: Install native deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install pkg-config

      # Windows generally builds out-of-the-box for these crates.
      # If you later need Vulkan SDK or other DLLs for runtime tests, add a step here.

      # ---- Cargo caches ----
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-registry-

      - name: Cache cargo git
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-git-

      - name: Cache build artifacts (target/)
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-target-

      # ---- Build (deterministic) ----
      # Build core working components (as per project instructions)
      - name: Build (debug) - Core Components
        run: |
          cargo build --locked --verbose \
            -p astraweave-core \
            -p astraweave-ai \
            -p astraweave-physics \
            -p astraweave-nav \
            -p astraweave-render \
            -p astraweave-gameplay \
            -p astraweave-audio \
            -p astraweave-npc \
            -p astraweave-input \
            -p astraweave-ui \
            -p astraweave-net \
            -p astraweave-director \
            -p astraweave-memory \
            -p astraweave-persona \
            -p astraweave-llm \
            -p astraweave-ipc \
            -p astraweave-author \
            -p hello_companion

      # Build working examples  
      - name: Build (debug) - Working Examples
        run: |
          cargo build --locked --verbose \
            -p visual_3d \
            -p physics_demo3d \
            -p quest_dialogue_demo \
            -p debug_overlay \
            -p rhai_authoring \
            -p phase_director \
            -p persona_loader \
            -p companion_profile \
            -p adaptive_boss \
            -p llm_toolcall \
            -p ipc_loopback \
            -p audio_spatial_demo \
            -p dialogue_voice_demo \
            -p coop_server \
            -p coop_client

      # Optionally, also build release artifacts for core components
      - name: Build (release) - Core Components  
        run: |
          cargo build --locked --release --verbose \
            -p astraweave-core \
            -p astraweave-ai \
            -p astraweave-physics \
            -p astraweave-nav \
            -p astraweave-render \
            -p hello_companion

      # Optional checks - only on core components to avoid known issues
      - name: Format check - Core Components
        run: |
          cargo fmt --check \
            -p astraweave-core \
            -p astraweave-ai \
            -p astraweave-physics \
            -p astraweave-nav \
            -p astraweave-render \
            -p hello_companion

      - name: Clippy (lint) - Core Components
        run: |
          cargo clippy \
            -p astraweave-core \
            -p astraweave-ai \
            -p astraweave-physics \
            -p astraweave-nav \
            -p astraweave-render \
            -p hello_companion \
            --all-features -- -D warnings

  # You can create a separate job for unit tests, but build is the top priority initially.
