name: Clippy Lint (Unwrap Prevention)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  clippy-p0-unwrap-check:
    name: "P0: Prevent New Unwraps"
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        crate:
          - astraweave-ecs
          - astraweave-core
          - astraweave-physics
          - astraweave-ai
          - astraweave-render
          - astraweave-audio
          - astraweave-embeddings
          - astraweave-memory
          - astraweave-llm
          - astraweave-context
          - astraweave-prompts
          - astraweave-net
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-
      
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-
      
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ matrix.crate }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-${{ matrix.crate }}-
      
      - name: "Clippy: Deny unwrap_used in lib code"
        run: |
          cargo clippy -p ${{ matrix.crate }} --lib -- \
            -D clippy::unwrap_used \
            -D clippy::expect_used \
            -D clippy::panic \
            -D clippy::todo \
            -A clippy::result_large_err
        continue-on-error: true
        id: clippy_lib
      
      - name: "Report Status"
        if: always()
        run: |
          if [ "${{ steps.clippy_lib.outcome }}" == "failure" ]; then
            echo "❌ ${{ matrix.crate }}: Found unwrap/expect/panic/todo in production code"
            echo "::warning::${{ matrix.crate }} has production unwraps that should be remediated"
            exit 1
          else
            echo "✅ ${{ matrix.crate }}: No unwraps in production code"
          fi

  clippy-p1-best-practices:
    name: "P1: Additional Lint Checks"
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        crate:
          - astraweave-gameplay
          - astraweave-nav
          - astraweave-behavior
          - astraweave-rag
          - astraweave-persona
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      
      - name: "Clippy: Warn on unwrap_used"
        run: |
          cargo clippy -p ${{ matrix.crate }} --lib -- \
            -W clippy::unwrap_used \
            -W clippy::expect_used \
            -W clippy::panic \
            -D clippy::dbg_macro \
            -D clippy::print_stdout \
            -D clippy::print_stderr
        continue-on-error: true

  summary:
    name: "Lint Summary"
    runs-on: ubuntu-latest
    needs: [clippy-p0-unwrap-check, clippy-p1-best-practices]
    if: always()
    
    steps:
      - name: Check P0 Results
        run: |
          if [ "${{ needs.clippy-p0-unwrap-check.result }}" == "failure" ]; then
            echo "⚠️  Some P0 crates have unwraps in production code"
            echo "    Run: cargo clippy -p <crate> --lib -- -D clippy::unwrap_used"
            echo "    to see specific locations and fix them"
          fi
          
          if [ "${{ needs.clippy-p0-unwrap-check.result }}" == "success" ]; then
            echo "✅ All P0 crates clean!"
          fi
      
      - name: Final Status
        run: |
          echo "P0 Unwrap Check: ${{ needs.clippy-p0-unwrap-check.result }}"
          echo "P1 Best Practices: ${{ needs.clippy-p1-best-practices.result }}"
          
          if [ "${{ needs.clippy-p0-unwrap-check.result }}" != "success" ]; then
            echo "::error::P0 crates have production unwraps - see job logs for details"
            exit 1
          fi
