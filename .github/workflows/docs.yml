name: Documentation

on:
  push:
    branches: [ "main" ]
    paths:
      - '**/*.rs'
      - '**/*.md'
      - 'docs/**'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - '**/*.rs'
      - '**/*.md'
      - 'docs/**'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    name: Build and Deploy Docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libudev-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Install mdBook and plugins
        continue-on-error: true
        run: |
          cargo install mdbook mdbook-mermaid mdbook-admonish || echo "mdBook install had warnings"
          mdbook-admonish install docs || echo "mdBook admonish setup had warnings"

      - name: Build API documentation
        continue-on-error: true
        run: |
          cargo doc --no-deps \
            --package astraweave-core \
            --package astraweave-ai \
            --package astraweave-physics \
            --package astraweave-nav \
            --package astraweave-render \
            --package astraweave-ecs \
            --package astraweave-behavior \
            --package astraweave-llm \
            --package astraweave-gameplay \
            --package astraweave-terrain || echo "Some packages had doc warnings"
          echo '<meta http-equiv="refresh" content="0; url=astraweave_core/index.html">' > target/doc/index.html

      - name: Build mdBook documentation
        continue-on-error: true
        run: |
          cd docs
          mdbook build
          mkdir -p book/api
          cp -r ../target/doc/* book/api/
          echo '<meta http-equiv="refresh" content="0; url=astraweave_core/index.html">' > book/api/index.html
          touch book/.nojekyll
          cp src/robots.txt book/robots.txt
          mkdir -p book/assets
          cp -r src/assets/* book/assets/

      - name: Generate sitemap
        run: |
          chmod +x docs/scripts/generate-sitemap.sh
          docs/scripts/generate-sitemap.sh docs/book

      - name: Check for broken links
        run: |
          curl -sSL https://github.com/lycheeverse/lychee/releases/download/v0.15.1/lychee-v0.15.1-x86_64-unknown-linux-gnu.tar.gz | tar -xz
          ./lychee docs/book/**/*.html \
            --exclude localhost \
            --exclude 127.0.0.1 \
            --exclude "file://" \
            --format markdown \
            --output link-report.md || true
          if [ -f link-report.md ]; then
            echo "### Link Check Report" >> $GITHUB_STEP_SUMMARY
            cat link-report.md >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Upload link report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: link-report
          path: link-report.md
          retention-days: 7

      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/book
          publish_branch: gh-pages
          keep_files: true
          exclude_assets: 'benchmarks/**'
          commit_message: 'Deploy mdBook documentation: ${{ github.sha }}'

      - name: Summary
        run: |
          echo "### Documentation Deployed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Documentation URL**: https://lazyxeon.github.io/AstraWeave-AI-Native-Gaming-Engine/" >> $GITHUB_STEP_SUMMARY
          echo "**API Docs URL**: https://lazyxeon.github.io/AstraWeave-AI-Native-Gaming-Engine/api/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Last Updated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
